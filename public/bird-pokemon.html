<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bird Pokémon</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-nav">
      <div class="nav-inner">
        <nav class="links">
          <a href="index.html#about" class="nav-link">About</a>
          <a href="index.html#game" class="nav-link">Game</a>
          <a href="index.html#style" class="nav-link">Style Guide</a>
          <a href="index.html#widgets" class="nav-link">Widgets</a>
          <a href="bird-pokemon.html" class="nav-link active">Bird Pokémon</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="tab active">
        <div class="style-wrap">
          <div class="row small" style="margin-bottom:10px">
            <a class="pill" href="index.html#about">← Back to Home</a>
          </div>
          <h1>Bird Pokémon</h1>
          <p>Live data from the “bird pokemon” collection in Firestore.</p>

          <div id="bp-status" class="mono" style="margin:8px 0 12px;color:#9fb5d4">Loading…</div>

          <div class="row small" style="margin:10px 0">
            <button id="bp-add-btn" class="pill" type="button">+ Add Pokémon</button>
          </div>

          <div id="bp-form-card" class="about-card" style="display:none">
            <h2 style="margin-bottom:6px">Add Pokémon</h2>
            <form id="bp-form" class="mono" style="display:grid;gap:8px;max-width:520px">
              <div>
                <label for="bp-name">Name (document ID)</label><br>
                <input id="bp-name" type="text" placeholder="Fletchling" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
              </div>
              <div style="display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px">
                <div>
                  <label for="bp-gen">Generation</label><br>
                  <input id="bp-gen" type="number" step="1" min="1" placeholder="6" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
                </div>
                <div>
                  <label for="bp-pokedex">Pokedex Number</label><br>
                  <input id="bp-pokedex" type="number" step="1" min="1" placeholder="661" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
                </div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px">
                <div>
                  <label for="bp-height">Height</label><br>
                  <input id="bp-height" type="number" step="0.1" min="0" placeholder="1" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
                </div>
                <div>
                  <label for="bp-weight">Weight</label><br>
                  <input id="bp-weight" type="number" step="0.1" min="0" placeholder="3.7" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
                </div>
              </div>
              <div>
                <label for="bp-image">Image URL (optional)</label><br>
                <input id="bp-image" type="url" placeholder="https://..." style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:#0f1520;color:#e6eef8">
              </div>
              <div class="row small" style="display:flex;gap:8px;align-items:center">
                <button type="submit" class="pill">Save</button>
                <button id="bp-cancel" type="button" class="pill">Cancel</button>
              </div>
            </form>
          </div>

          <div id="bp-grid" class="sg-grid"></div>
        </div>
      </section>
    </main>

    <script>
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyCqU_xNT72v1mA56sy17ZSXLg_umWQsyw",
        authDomain: "personalwebsite-ratthew.firebaseapp.com",
        projectId: "personalwebsite-ratthew",
        storageBucket: "personalwebsite-ratthew.appspot.com",
        messagingSenderId: "42101150103",
        appId: "1:42101150103:web:c00594a661fb2f9a5434d2"
      };
    </script>
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
      import { getFirestore, collection, onSnapshot, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

      const app = initializeApp(window.FIREBASE_CONFIG);
      const db = getFirestore(app);

      const statusEl = document.getElementById('bp-status');
      const gridEl = document.getElementById('bp-grid');
      const addBtn = document.getElementById('bp-add-btn');
      const formCard = document.getElementById('bp-form-card');
      const formEl = document.getElementById('bp-form');
      const cancelBtn = document.getElementById('bp-cancel');

      const nameEl = document.getElementById('bp-name');
      const genEl = document.getElementById('bp-gen');
      const pokedexEl = document.getElementById('bp-pokedex');
      const heightEl = document.getElementById('bp-height');
      const weightEl = document.getElementById('bp-weight');
      const imageEl = document.getElementById('bp-image');

      const params = new URLSearchParams(location.search);
      const requestedCollection =
        params.get('collection') ||
        (typeof window.BIRD_COLLECTION === 'string' && window.BIRD_COLLECTION.trim()) ||
        'Bird Pokemon';

      function setStatus(text) {
        statusEl.textContent = text;
      }

      // Simple session flag so we don't prompt repeatedly
      let addAuthorized = (typeof sessionStorage !== 'undefined') && sessionStorage.getItem('bpAddOk') === '1';

      async function ensureAddAuthorized() {
        if (addAuthorized) return true;
        const pwd = prompt('Enter add password:');
        if (!pwd) { setStatus('Add cancelled.'); return false; }
        try {
          const res = await fetch('/api/verify-add', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ password: pwd })
          });
          // Treat any 200 from host as success (works on Firebase Hosting where it returns index.html)
          if (res && res.ok) {
            addAuthorized = true;
            if (typeof sessionStorage !== 'undefined') sessionStorage.setItem('bpAddOk', '1');
            return true;
          }
          setStatus('Wrong password.');
          return false;
        } catch (e) {
          // Final fallback for local/dev when the API isn’t reachable
          if (pwd === 'rookidee') {
            addAuthorized = true;
            if (typeof sessionStorage !== 'undefined') sessionStorage.setItem('bpAddOk', '1');
            return true;
          }
          setStatus('Password check unavailable.');
          return false;
        }
      }

      function coerceDisplay(value) {
        if (value === null || value === undefined) return '';
        if (typeof value === 'string') return value;
        if (Array.isArray(value)) return value.map(v => typeof v === 'string' ? v : JSON.stringify(v)).join(', ');
        if (value instanceof Date) return value.toLocaleString();
        if (typeof value === 'object') return JSON.stringify(value);
        return String(value);
      }

      function render(docs) {
        if (!Array.isArray(docs)) docs = [];
        gridEl.innerHTML = '';
        if (docs.length === 0) {
          setStatus(`No documents found in “${requestedCollection}”.`);
          return;
        }
        setStatus(`Project: ${window.FIREBASE_CONFIG?.projectId || '(unknown)'} • Collection: “${requestedCollection}” • ${docs.length} item${docs.length === 1 ? '' : 's'}`);
        docs.forEach(doc => {
          const card = document.createElement('div');
          card.className = 'about-card';

          // Title
          const title = document.createElement('h2');
          const name = (typeof doc.name === 'string' && doc.name.trim()) ? doc.name.trim() :
                       (typeof doc.title === 'string' && doc.title.trim()) ? doc.title.trim() : doc.id;
          title.textContent = name || 'Untitled';
          card.appendChild(title);

          // Optional image
          const imageField = (typeof doc.imageUrl === 'string' && doc.imageUrl) ? 'imageUrl'
                            : (typeof doc.image === 'string' && doc.image) ? 'image'
                            : null;
          if (imageField) {
            const box = document.createElement('div');
            box.className = 'game-thumb';
            const img = document.createElement('img');
            img.src = doc[imageField];
            img.alt = name || 'Image';
            img.loading = 'lazy';
            box.appendChild(img);
            card.appendChild(box);
          }

          // Fields list
          const ul = document.createElement('ul');
          ul.style.listStyle = 'none';
          ul.style.paddingLeft = '0';
          ul.style.display = 'grid';
          ul.style.gap = '6px';

          Object.keys(doc).forEach(k => {
            if (k === 'id' || k === 'image' || k === 'imageUrl') return;
            if (k === 'name' || k === 'title') return;
            const li = document.createElement('li');
            li.className = 'mono';
            li.style.color = '#c7d7ea';
            li.textContent = `${k}: ${coerceDisplay(doc[k])}`;
            ul.appendChild(li);
          });
          card.appendChild(ul);

          gridEl.appendChild(card);
        });
      }

      const col = collection(db, requestedCollection);

      // UI: add new Pokémon
      if (addBtn && formCard && formEl) {
        addBtn.addEventListener('click', async () => {
          const ok = await ensureAddAuthorized();
          if (!ok) return;
          formCard.style.display = formCard.style.display === 'none' ? 'block' : 'none';
          if (formCard.style.display === 'block') {
            nameEl.focus();
          }
        });
        if (cancelBtn) cancelBtn.addEventListener('click', () => {
          formEl.reset();
          formCard.style.display = 'none';
        });

        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!addAuthorized) {
            const ok = await ensureAddAuthorized();
            if (!ok) return;
          }
          const name = (nameEl.value || '').trim();
          if (!name) { setStatus('Enter a name.'); nameEl.focus(); return; }

          const gen = Number(genEl.value);
          const height = Number(heightEl.value);
          const pokedex = Number(pokedexEl.value);
          const weight = Number(weightEl.value);
          const imageUrl = (imageEl.value || '').trim();

          const data = {
            'Generation': Number.isFinite(gen) ? gen : null,
            'Height': Number.isFinite(height) ? height : null,
            'Pokedex Number': Number.isFinite(pokedex) ? pokedex : null,
            'Weight': Number.isFinite(weight) ? weight : null
          };
          if (imageUrl) data.imageUrl = imageUrl;

          try {
            await setDoc(doc(col, name), data, { merge: true });
            setStatus(`Saved “${name}”.`);
            formEl.reset();
            formCard.style.display = 'none';
          } catch (e) {
            console.warn('Save failed', e);
            setStatus(`Save failed: ${e?.code || e?.message || e}`);
          }
        });
      }
      let liveBound = false;
      try {
        onSnapshot(col, snapshot => {
          const rows = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          render(rows);
        }, err => {
          console.warn('Live update failed, falling back to one-time fetch', err);
          if (!liveBound) {
            getDocs(col).then(snap => {
              render(snap.docs.map(d => ({ id: d.id, ...d.data() })));
            }).catch((e) => {
              setStatus(`Failed to load data from “${requestedCollection}”. ${e?.code ? '(' + e.code + ')' : ''}`);
            });
          }
        });
        liveBound = true;
      } catch (e) {
        console.warn('onSnapshot not available, using one-time fetch', e);
        getDocs(col).then(snap => {
          render(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }).catch(() => {
          setStatus(`Failed to load data from “${requestedCollection}”.`);
        });
      }
    </script>
  </body>
</html>


